     ,----------.                                     ,-------.                                                   ,------.                                                           ,---.          ,---------------.
     |Native App|                                     |Browser|                                                   |Apigee|                                                           |IAM|          |Resource Server|
     `----+-----'                                     `---+---'                                                   `--+---'                                                           `-+-'          `-------+-------'
   ,--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!. 
   |GET Authorize                                                                                                                                                                                                 |_\
   `----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------'
          |----.                                                                                                     |                                                                 |                    |        
          |    | <b>1</b>                                                                                            |                                                                 |                    |        
          |<---' Generate and store code_verifier and state                                                          |                                                                 |                    |        
          |                                                                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |----.                                          |                                                          |                                                                 |                    |        
          |    | <b>2</b>                                 |                                                          |                                                                 |                    |        
          |<---' Create code challenge                    |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                 3 Open Browser                |                                                          |                                                                 |                    |        
          | ---------------------------------------------->                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               | 4 GET /authorize?client_id=...code_challenge=...state=...|                                                                 |                    |        
          |                                               | --------------------------------------------------------->                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |----.                                                            |                    |        
          |                                               |                                                          |    | <b>5</b>                                                   |                    |        
          |                                               |                                                          |<---' code_challenge stored as Attribute on Authorization Code   |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                            ,----------------------------------------------------------------------------------------------------------------------------------!.                |        
          |                                            |Login and Consent Flow                                                                                                            |_\               |        
          |                                            `------------------------------------------------------------------------------------------------------------------------------------'               |        
          |                                               |                                                          |  6                                                              |                    |        
          |                                               | --------------------------------------------------------------------------------------------------------------------------->                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |  7                                                              |                    |        
          |                                               | <---------------------------------------------------------------------------------------------------------------------------                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                            ,----------------------------------------------------------------------------------------------------------------------------------!.                |        
          |                                            |User successfully authenticates and consents in browser                                                                           |_\               |        
          |                                            `------------------------------------------------------------------------------------------------------------------------------------'               |        
          |                                               |     8 302 Location: (redirect uri)?code=...&state=...    |                                                                 |                    |        
          |                                               | <---------------------------------------------------------                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |               9 Follow redirect               |                                                          |                                                                 |                    |        
          | <----------------------------------------------                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |----.                                          |                                                          |                                                                 |                    |        
          |    | <b>10</b>                                |                                                          |                                                                 |                    |        
          |<---' Check state                              |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
   ,--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------!. 
   |POST Token                                                                                                                                                                                                    |_\
   `----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------'
          |                                 11 POST /token code=... code_verifier=...                                |                                                                 |                    |        
          | --------------------------------------------------------------------------------------------------------->                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |----.                                                                                 |        
          |                                               |                                                          |    | <b>12</b>                                                                       |        
          |                                               |                                                          |<---' Retrieve code_challenge Attribute and validate code_verifier                    |        
          |                                               |                                                          |                                                                                      |        
          |                                               |                                                          |                                                                 |                    |        
          |                                13 200 OK + access_token, refresh_token...                                |                                                                 |                    |        
          | <---------------------------------------------------------------------------------------------------------                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                      14 GET /accounts + bearer token                                     |                                                                 |                    |        
          | --------------------------------------------------------------------------------------------------------->                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |----.                                                            |                    |        
          |                                               |                                                          |    | <b>15</b>                                                  |                    |        
          |                                               |                                                          |<---' Validate token                                             |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                   16 GET /accounts              |                    |        
          |                                               |                                                          | ------------------------------------------------------------------------------------->        
          |                                               |                                                          |                                                                 |                    |        
          |                                               |                                                          |                                 17 200 OK + response            |                    |        
          |                                               |                                                          | <-------------------------------------------------------------------------------------        
          |                                               |                                                          |                                                                 |                    |        
          |                                           18 200 OK + response                                           |                                                                 |                    |        
          | <---------------------------------------------------------------------------------------------------------                                                                 |                    |        
     ,----+-----.                                     ,---+---.                                                   ,--+---.                                                           ,-+-.          ,-------+-------.
     |Native App|                                     |Browser|                                                   |Apigee|                                                           |IAM|          |Resource Server|
     `----------'                                     `-------'                                                   `------'                                                           `---'          `---------------'
